<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>뉴키즈 - 통합 관리자 시스템</title>

    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="admin.css">
    <style>
        .color-picker-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }

        .color-picker-label {
            font-size: 0.7rem;
            color: #666;
        }

        .opacity-val {
            font-size: 0.75rem;
            color: #1a3c6e;
            font-weight: bold;
        }

        .badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-right: 5px;
        }
    </style>
</head>
<body>

    <div id="loading" class="loading-overlay">처리 중입니다...</div>

    <div id="login-section">
        <div class="login-box">
            <h2 style="text-align:center; margin-bottom:30px; color:#1a3c6e;">🔒 관리자 로그인</h2>
            <div class="form-group"><label class="form-label">아이디</label><input type="email" id="admin-email" class="form-input" placeholder="admin@newkids.com"></div>
            <div class="form-group" style="margin-top:15px;"><label class="form-label">비밀번호</label><input type="password" id="admin-password" class="form-input" placeholder="비밀번호"></div>
            <div class="btn-center-wrap"><button onclick="adminLogin()" class="btn-action" style="width: 100%;">로그인</button></div>
            <p style="text-align:center; margin-top:20px; font-size:0.9rem;"><a href="index.html" style="color:#666;">← 홈페이지로 돌아가기</a></p>
        </div>
    </div>

    <div id="admin-layout" class="admin-layout" style="display:none;">
        <nav class="sidebar">
            <div class="sidebar-logo">🏢 <span>뉴키즈 관리자</span></div>
            <div class="nav-item active" onclick="switchTab('dashboard', this)">📊 <span class="nav-text">대시보드</span></div>
            <div class="nav-item" onclick="switchTab('posts', this)">📝 <span class="nav-text">게시글 관리</span></div>
            <div class="nav-item" onclick="switchTab('category', this)">🖼️ <span class="nav-text">서브 페이지 관리</span></div>
            <div class="nav-item" onclick="switchTab('sheets', this)">📑 <span class="nav-text">신청서 확인</span></div>
            <div class="nav-item" onclick="switchTab('settings', this)">⚙️ <span class="nav-text">환경 설정</span></div>
            <div class="nav-item" onclick="location.href='index.html'">🏠 <span class="nav-text">홈페이지 이동</span></div>
            <div class="nav-item logout-btn" onclick="adminLogout()">🚪 <span class="nav-text">로그아웃</span></div>
        </nav>

        <main class="main-content">
            <div id="tab-dashboard" class="admin-section active">
                <h1 style="color:#333; border-bottom:2px solid #ddd; padding-bottom:15px;">관리자 대시보드</h1>
                <div class="dash-grid">
                    <div class="dash-card" onclick="switchTab('posts', document.querySelectorAll('.nav-item')[1])"><span class="dash-icon">📝</span><div class="dash-title">게시글 작성하기</div></div>
                    <div class="dash-card" onclick="switchTab('category', document.querySelectorAll('.nav-item')[2])"><span class="dash-icon">🖼️</span><div class="dash-title">서브 페이지 관리</div></div>
                    <div class="dash-card" onclick="openSavedSheet()"><span class="dash-icon">📊</span><div class="dash-title">신청서 확인</div></div>
                    <div class="dash-card" onclick="switchTab('settings', document.querySelectorAll('.nav-item')[4])"><span class="dash-icon">⚙️</span><div class="dash-title">환경 설정</div></div>
                </div>
            </div>

            <div id="tab-posts" class="admin-section">
                <div class="panel-box">
                    <h2 id="form-title" style="border-bottom:2px solid #1a3c6e; padding-bottom:15px; margin-bottom:20px;">📝 게시글 작성/수정</h2>
                    <div style="background:#fff3cd; padding:15px; border-radius:8px; margin-bottom:20px; border:1px solid #ffeeba;">
                        <label style="font-weight:bold; margin-right:20px; color:#856404;">📢 노출 위치 선택</label>
                        <div style="display:inline-flex; gap:20px; align-items:center;">
                            <label style="cursor:pointer; display:flex; align-items:center;"><input type="checkbox" id="chk-intro" checked onchange="toggleEditorState()" style="width:18px; height:18px; margin-right:5px;"><strong>소개 페이지</strong></label>
                            <label style="cursor:pointer; display:flex; align-items:center;"><input type="checkbox" id="chk-order" onchange="toggleEditorState()" style="width:18px; height:18px; margin-right:5px;"><strong>발주 페이지</strong></label>
                        </div>
                    </div>
                    <input type="file" id="hidden-image-input" accept="image/*" multiple style="display:none;">
                    <div class="write-inline-row">
                        <div class="form-group w-col-order" style="margin-bottom:0;"><label class="form-label">순서</label><input type="number" id="post-order" class="form-input" value="0" style="text-align:center; padding: 12px 5px;"></div>
                        <div class="form-group w-col-category" style="margin-bottom:0;"><label class="form-label">카테고리</label><select id="post-category" class="form-input"><option value="">로딩 중...</option></select></div>
                        <div class="form-group w-col-title" style="margin-bottom:0;"><label class="form-label">제목 (교재명)</label><input type="text" id="post-title" class="form-input" placeholder="제목을 입력하세요"></div>
                    </div>
                    <div class="form-group"><label class="form-label">썸네일 이미지</label><input type="file" id="post-thumb-file" class="form-input" accept="image/*"><div id="thumb-manage-area" style="display:none; margin-top:5px;"><label><input type="checkbox" id="delete-thumb-check"> 기존 썸네일 삭제</label></div></div>
                    <div class="form-group" id="editor-area"><label class="form-label">내용</label><div id="editor-container"></div></div>
                    <div class="form-group" style="margin-top:20px;"><label class="form-label">상세 이미지/동영상</label><input type="file" id="post-file" class="form-input" accept="image/*,video/*"><div id="file-manage-area" style="display:none; margin-top:5px;"><label><input type="checkbox" id="delete-file-check"> 기존 파일 삭제</label></div></div>
                    <div class="form-grid"><div class="form-group"><label class="form-label">유튜브 URL</label><input type="text" id="youtube-url" class="form-input"></div><div class="form-group"><label class="form-label">링크 URL</label><input type="text" id="post-link" class="form-input"></div></div>
                    <div class="btn-center-wrap"><button id="btn-submit" onclick="uploadPost()" class="btn-action" style="min-width: 200px;">업로드 저장</button><button id="btn-cancel-edit" onclick="cancelEdit()" class="btn-action" style="display:none; background-color:#666;">취소</button></div>
                </div>
                <div class="panel-box" style="margin-top: 30px;">
                    <div class="admin-list-header"><h3 style="margin:0;">📂 등록된 게시글 목록</h3><select id="filter-category" class="form-input" style="width:auto;" onchange="loadManageList(1)"></select></div>
                    <div id="manage-list"></div><div id="pagination-controls" class="pagination"></div>
                </div>
            </div>

            <div id="tab-category" class="admin-section">
                <h2 style="border-bottom:2px solid #1a3c6e; padding-bottom:15px;">🖼️ 서브 페이지 관리</h2>
                <div class="panel-box" style="margin-bottom:30px; border:2px dashed #1a3c6e; background:#f0f7ff;">
                    <h3 style="margin-bottom:15px; color:#1a3c6e;">➕ 새 카테고리(메뉴) 추가</h3>
                    <div style="display: flex; gap: 15px; margin-bottom: 15px; align-items: flex-end;">
                        <div class="form-group" style="flex: 0 0 150px; margin-bottom:0;">
                            <label class="form-label">유형</label>
                            <select id="new-cat-type" class="form-input">
                                <option value="EDU">교육 (child.html)</option>
                                <option value="EVENT">행사 (program.html)</option>
                                <option value="BOARD">📌 게시판 전용</option>
                                <option value="PAGE">⚙️ 고정 페이지 (견적/발주)</option>
                            </select>
                        </div>
                        <div class="form-group" style="flex: 0 0 150px; margin-bottom:0;"><label class="form-label">코드 (영문)</label><input type="text" id="new-cat-code" class="form-input" placeholder="예: cooking"></div>
                        <div class="form-group" style="flex: 1; margin-bottom:0;"><label class="form-label">메뉴 이름</label><input type="text" id="new-cat-name" class="form-input" placeholder="예: 요리 활동"></div>
                    </div>
                    <div style="display: flex; gap: 15px; margin-bottom: 15px; align-items: flex-end;">
                        <div class="form-group" style="flex: 1; margin-bottom:0;"><label class="form-label">배경 이미지</label><input type="file" id="new-cat-file" class="form-input" accept="image/*" style="background:#fff;"></div>
                        <div class="form-group" style="flex: 2; margin-bottom:0;"><label class="form-label">설명글</label><input type="text" id="new-cat-desc" class="form-input"></div>
                    </div>
                    <div style="text-align: right;"><button onclick="addNewCategory()" class="btn-action">카테고리 생성</button></div>
                </div>
                <div class="panel-box">
                    <p style="color:#666; margin-bottom:20px;">
                        <strong>[O색]</strong>은 오버레이 색상, <strong>[투명도]</strong>는 0.0~1.0 입니다. '견적 요청', '교재 발주' 페이지도 여기서 배경을 설정하세요.
                    </p>
                    <div id="category-list-container">로딩 중...</div>
                </div>
            </div>

            <div id="tab-sheets" class="admin-section">
                <h2 style="border-bottom:2px solid #1a3c6e; padding-bottom:15px;">📑 신청서 관리</h2>
                <div class="form-group"><label class="form-label">🔗 구글 시트 주소</label><div style="display:flex; gap:10px;"><input type="text" id="sheet-url-input" class="form-input"><button onclick="saveSheetUrl()" class="btn" style="width:100px;">저장</button></div></div>
                <div class="dash-grid" style="margin-top:40px;"><div class="dash-card" onclick="openSavedSheet()"><span class="dash-icon" style="color:#2ecc71;">📊</span><div class="dash-title">구글 시트 열기</div></div></div>
            </div>

            <div id="tab-settings" class="admin-section">
                <h2 style="border-bottom:2px solid #1a3c6e; padding-bottom:15px;">⚙️ 환경 설정</h2>
                <div class="panel-box">
                    <h3 class="form-section-title">🏠 메인 페이지(첫 화면) 관리</h3>
                    <div style="background:#f9f9f9; padding:30px; border-radius:12px; border:1px solid #eee;">
                        <div class="form-group"><label class="form-label">메인 큰 제목</label><input type="text" id="conf-main-title" class="form-input"></div>
                        <div class="form-group"><label class="form-label">메인 설명글</label><textarea id="conf-main-desc" class="form-inputp"></textarea></div>
                        <div class="form-group" style="margin-top:15px; border-top:1px dashed #ccc; padding-top:15px;">
                            <label class="form-label">텍스트 색상</label>
                            <div style="display:flex; gap:30px;">
                                <div class="color-picker-group"><span class="color-picker-label">큰 제목</span><input type="color" id="conf-main-title-color" style="cursor:pointer;"></div>
                                <div class="color-picker-group"><span class="color-picker-label">설명글</span><input type="color" id="conf-main-desc-color" style="cursor:pointer;"></div>
                            </div>
                        </div>
                        <div style="display:flex; gap:30px; align-items:flex-start; margin-top:30px; border-top:1px dashed #ccc; padding-top:30px;">
                            <div style="text-align:center;">
                                <p style="font-size:0.9rem; margin-bottom:10px; color:#666; font-weight:bold;">현재 배경</p>
                                <img id="preview-main-hero" src="" style="width:300px; height:170px; object-fit:cover; border-radius:8px; border:1px solid #ccc; background:#e0e0e0;">
                                <button onclick="deleteMainHeroImage()" class="btn-mini" style="margin-top:10px; background:#ff6b6b; color:#fff; border:none; width:100%;">🗑️ 이미지 삭제</button>
                            </div>
                            <div style="flex:1;">
                                <label class="form-label">배경 이미지 변경</label><input type="file" id="conf-main-hero" class="form-input" accept="image/*">
                                <div style="display:flex; gap:30px; margin-top:20px;">
                                    <div><label class="form-label">배경 색상</label><input type="color" id="conf-main-bg-color" style="height:40px; cursor:pointer;"></div>
                                    <div><label class="form-label">오버레이 색상</label><input type="color" id="conf-main-overlay-color" style="height:40px; cursor:pointer;"></div>
                                    <div><label class="form-label">투명도</label><div style="display:flex; align-items:center; gap:10px;"><input type="range" id="conf-main-overlay-opacity" min="0" max="1" step="0.1" oninput="document.getElementById('op-val-main').innerText=this.value"><span id="op-val-main" class="opacity-val">0.4</span></div></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <h3 class="form-section-title" style="margin-top:40px;">🏢 회사 정보 & 🎨 디자인</h3>
                    <div class="form-grid"><div class="form-group"><label class="form-label">회사명</label><input type="text" id="conf-name" class="form-input"></div><div class="form-group"><label class="form-label">대표자</label><input type="text" id="conf-ceo" class="form-input"></div></div>
                    <div class="form-group"><label class="form-label">주소</label><input type="text" id="conf-addr" class="form-input"></div><div class="form-group"><label class="form-label">연락처</label><input type="text" id="conf-phone" class="form-input"></div>
                    <div class="form-grid"><div class="form-group"><label class="form-label">메인 컬러</label><input type="color" id="conf-primary" class="form-input" style="height:50px;"></div><div class="form-group"><label class="form-label">강조 컬러</label><input type="color" id="conf-accent" class="form-input" style="height:50px;"></div></div>
                    <div class="btn-center-wrap"><button onclick="saveSiteConfig()" class="btn-action">설정 저장하기</button></div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script src="https://unpkg.com/quill-blot-formatter@1.0.5/dist/quill-blot-formatter.min.js"></script>
    <script src="config.js"></script>
    <script src="manager.js"></script>

    <script>
        let editingId = null; let originalDetailUrl = null; let originalThumbUrl = null; let originalMainHero = null; let isMainHeroDeleted = false; let quill; const ITEMS_PER_PAGE = 12; let currentPage = 1; let categoryList = []; const FLAG_ORDER_ONLY = 'ORDER_ITEM'; const FLAG_ORDER_ALL = 'ORDER_ALL';
        function getYoutubeId(url) { if (!url) return null; const m = url.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/); return (m && m[2].length === 11) ? m[2] : null; }
        function getFirstImageFromContent(html) { const d = document.createElement('div'); d.innerHTML = html; const i = d.querySelector('img'); return i ? i.src : null; }

        document.addEventListener("DOMContentLoaded", async function () {
            Quill.register('modules/blotFormatter', QuillBlotFormatter.default);
            quill = new Quill('#editor-container', { theme: 'snow', modules: { blotFormatter: {}, toolbar: { container: [[{ 'header': [1, 2, 3, false] }], ['bold', 'italic', 'underline', { 'color': [] }, { 'background': [] }], [{ 'align': [] }, 'link', 'image', 'video']], handlers: { image: function () { document.getElementById('hidden-image-input').click(); } } } } });
            document.getElementById('hidden-image-input').addEventListener('change', function () { if (this.files.length > 0) uploadAndInsertImages(this.files); });
            const savedUrl = localStorage.getItem('mySheetUrl'); if (savedUrl) document.getElementById('sheet-url-input').value = savedUrl;
            try { const { data: { session } } = await window.sb.auth.getSession(); if (session) { showAdminMode(); loadConfigToForm(); loadAdminCategories(); populateCategorySelects(); } else { document.getElementById('login-section').style.display = 'flex'; } } catch (e) { console.error(e); }
        });

        // [카테고리/페이지 관리]
        async function loadAdminCategories() {
            const listDiv = document.getElementById('category-list-container');
            try {
                const { data, error } = await window.sb.from('program_categories').select('*').order('order_num', { ascending: true });
                if (error) throw error;
                if (!data || data.length === 0) { listDiv.innerHTML = "<div style='text-align:center; padding:30px;'>카테고리 없음</div>"; return; }

                categoryList = data;
                const gridStyle = "grid-template-columns: 60px 40px 70px 100px 100px 35px 35px 35px 35px 50px 1fr 80px 50px 100px;";
                let html = `<div class="cat-manage-layout cat-manage-header" style="${gridStyle}">
                        <div>유형</div><div>순서</div><div>코드</div><div>메뉴명</div><div>제목</div><div>T색</div><div>C색</div><div>B색</div><div>O색</div><div>투명도</div><div>설명글</div><div>이미지</div><div>노출</div><div>관리</div>
                    </div>`;

                data.forEach((cat, index) => {
                    const thumb = cat.hero_image || 'https://via.placeholder.com/50?text=None';
                    const titleColor = cat.hero_title_color || '#ffffff'; const descColor = cat.hero_desc_color || '#ffffff'; const bgColor = cat.hero_bg_color || '#1a3c6e'; const overlayColor = cat.hero_overlay_color || '#1a3c6e'; const overlayOpacity = cat.hero_overlay_opacity !== undefined ? cat.hero_overlay_opacity : 0.8;

                    let badgeColor = '#999'; let badgeText = cat.type;
                    if (cat.type === 'EDU') { badgeColor = '#1a3c6e'; badgeText = '교육'; }
                    else if (cat.type === 'EVENT') { badgeColor = '#f4a261'; badgeText = '행사'; }
                    else if (cat.type === 'BOARD') { badgeColor = '#27ae60'; badgeText = '게시판'; }
                    else if (cat.type === 'PAGE') { badgeColor = '#666'; badgeText = '페이지'; }

                    const isVisible = cat.is_visible !== false;
                    const visBtn = isVisible ? `<button class="btn-mini" style="background:#27ae60; color:#fff;" onclick="toggleVisibility('${cat.code}', false)">ON</button>` : `<button class="btn-mini" style="background:#999; color:#fff;" onclick="toggleVisibility('${cat.code}', true)">OFF</button>`;

                    html += `<div class="cat-manage-layout cat-manage-row" style="${gridStyle}">
                            <div class="cat-cell-center"><span class="type-badge" style="background:${badgeColor}">${badgeText}</span></div>
                            <div class="cat-cell-center"><button class="btn-order" onclick="moveCategory(${index}, -1)">▲</button><button class="btn-order" onclick="moveCategory(${index}, 1)">▼</button></div>
                            <div class="cat-cell-center" style="font-weight:bold; font-size:0.8rem;">${cat.code}</div>
                            <div class="cat-cell-input"><input type="text" id="name-${cat.code}" value="${cat.name}"></div>
                            <div class="cat-cell-input"><input type="text" id="title-${cat.code}" value="${cat.hero_title || ''}"></div>
                            <div class="cat-cell-center"><input type="color" id="t-color-${cat.code}" value="${titleColor}" title="제목 색상" style="width:25px; border:none; background:none; cursor:pointer;"></div>
                            <div class="cat-cell-center"><input type="color" id="d-color-${cat.code}" value="${descColor}" title="설명 색상" style="width:25px; border:none; background:none; cursor:pointer;"></div>
                            <div class="cat-cell-center"><input type="color" id="b-color-${cat.code}" value="${bgColor}" title="배경 색상" style="width:25px; border:none; background:none; cursor:pointer;"></div>
                            <div class="cat-cell-center"><input type="color" id="o-color-${cat.code}" value="${overlayColor}" title="오버레이 색상" style="width:25px; border:none; background:none; cursor:pointer;"></div>
                            <div class="cat-cell-center"><input type="number" id="o-op-${cat.code}" value="${overlayOpacity}" step="0.1" min="0" max="1" style="width:40px; padding:2px; font-size:0.8rem;"></div>
                            <div class="cat-cell-input"><input type="text" id="desc-${cat.code}" value="${cat.hero_desc || ''}"></div>
                            <div class="cat-cell-center" style="display:flex; flex-direction:column; align-items:center; gap:5px;">
                                <img src="${thumb}" style="width:40px; height:40px; object-fit:cover; cursor:pointer;" onclick="document.getElementById('file-${cat.code}').click()">
                                <input type="file" id="file-${cat.code}" style="display:none;" accept="image/*">
                                <button class="btn-mini" style="font-size:0.6rem; color:red;" onclick="deleteSubHeroImage('${cat.code}')">삭제</button>
                            </div>
                            <div class="cat-cell-center">${visBtn}</div>
                            <div class="cat-cell-center">
                                <button onclick="updateCategory('${cat.code}')" class="btn-mini" style="background:#1a3c6e; color:#fff;">저장</button>
                                <button onclick="deleteCategory('${cat.code}')" class="btn-mini" style="background:#ff6b6b; color:#fff;">삭제</button>
                            </div>
                        </div>`;
                });
                listDiv.innerHTML = html;
            } catch (e) { listDiv.innerHTML = "로드 실패"; console.error(e); }
        }

        async function updateCategory(code) {
            const n = document.getElementById(`name-${code}`).value, t = document.getElementById(`title-${code}`).value, d = document.getElementById(`desc-${code}`).value;
            const tc = document.getElementById(`t-color-${code}`).value, dc = document.getElementById(`d-color-${code}`).value, bc = document.getElementById(`b-color-${code}`).value, oc = document.getElementById(`o-color-${code}`).value, op = document.getElementById(`o-op-${code}`).value;
            const f = document.getElementById(`file-${code}`).files[0]; let u = null; showLoading(true);
            if (f) { const { data } = await window.sb.storage.from('images').upload(`h_${Date.now()}`, f); u = window.sb.storage.from('images').getPublicUrl(data.path).data.publicUrl; }
            const ud = { name: n, hero_title: t, hero_desc: d, hero_title_color: tc, hero_desc_color: dc, hero_bg_color: bc, hero_overlay_color: oc, hero_overlay_opacity: parseFloat(op) }; if (u) ud.hero_image = u;
            await window.sb.from('program_categories').update(ud).eq('code', code); showLoading(false); alert("저장되었습니다."); loadAdminCategories();
        }

        async function addNewCategory() {
            const code = document.getElementById('new-cat-code').value.trim().toLowerCase(), name = document.getElementById('new-cat-name').value.trim(), type = document.getElementById('new-cat-type').value, desc = document.getElementById('new-cat-desc').value.trim();
            const { data } = await window.sb.from('program_categories').select('order_num').order('order_num', { ascending: false }).limit(1); const max = data && data.length > 0 ? data[0].order_num + 1 : 1;
            if (!code || !name) return alert("필수 입력");
            const f = document.getElementById('new-cat-file').files[0]; let u = null; if (f) { const { data } = await window.sb.storage.from('images').upload(`h_${Date.now()}`, f); u = window.sb.storage.from('images').getPublicUrl(data.path).data.publicUrl; }
            const { error } = await window.sb.from('program_categories').insert([{ code, name, type, hero_desc: desc, hero_image: u, order_num: max, is_visible: true }]);
            if (error) alert("실패: " + error.message); else { alert("추가됨"); document.getElementById('new-cat-code').value = ''; loadAdminCategories(); populateCategorySelects(); }
        }

        // [기타 함수들]
        async function toggleVisibility(c, s) { showLoading(true); await window.sb.from('program_categories').update({ is_visible: s }).eq('code', c); loadAdminCategories(); showLoading(false); }
        async function moveCategory(i, d) { const t = i + d; if (t < 0 || t >= categoryList.length) return; const c = categoryList[i], n = categoryList[t], tmp = c.order_num; showLoading(true); await window.sb.from('program_categories').update({ order_num: n.order_num }).eq('code', c.code); await window.sb.from('program_categories').update({ order_num: tmp }).eq('code', n.code); loadAdminCategories(); showLoading(false); }
        async function deleteSubHeroImage(c) { if (confirm("삭제?")) { showLoading(true); await window.sb.from('program_categories').update({ hero_image: null }).eq('code', c); showLoading(false); loadAdminCategories(); } }
        async function deleteCategory(c) { if (confirm("삭제?")) { await window.sb.from('program_categories').delete().eq('code', c); loadAdminCategories(); populateCategorySelects(); } }
        async function populateCategorySelects() { /* 기존 유지 */ }
        window.toggleEditorState = function () { /* 기존 유지 */ }
        async function uploadPost() { /* 기존 유지 */ }
        async function loadConfigToForm() {
            const { data } = await window.sb.from('site_config').select('*').eq('id', 1).single();
            if (data) {
                document.getElementById('conf-name').value = data.company_name || "";
                document.getElementById('conf-ceo').value = data.ceo_name || "";
                document.getElementById('conf-addr').value = data.address || "";
                document.getElementById('conf-phone').value = data.phone || "";
                document.getElementById('conf-primary').value = data.primary_color || "#1a3c6e";
                document.getElementById('conf-accent').value = data.accent_color || "#f4a261";
                document.getElementById('conf-main-title').value = data.main_hero_title || "";
                document.getElementById('conf-main-desc').value = data.main_hero_desc || "";
                document.getElementById('conf-main-title-color').value = data.main_hero_title_color || "#ffffff";
                document.getElementById('conf-main-desc-color').value = data.main_hero_desc_color || "#ffffff";
                document.getElementById('conf-main-bg-color').value = data.main_hero_bg_color || "#1a3c6e";
                document.getElementById('conf-main-overlay-color').value = data.main_hero_overlay_color || "#1a3c6e";
                const mop = data.main_hero_overlay_opacity !== undefined ? data.main_hero_overlay_opacity : 0.4;
                document.getElementById('conf-main-overlay-opacity').value = mop;
                document.getElementById('op-val-main').innerText = mop;
                if (data.main_hero_image) {
                    document.getElementById('preview-main-hero').src = data.main_hero_image;
                    originalMainHero = data.main_hero_image;
                    isMainHeroDeleted = false;
                } else {
                    document.getElementById('preview-main-hero').src = "https://via.placeholder.com/300x170?text=No+Image";
                    isMainHeroDeleted = true;
                }
            }
        }
        window.saveSiteConfig = async function () {
            if (!confirm("저장하시겠습니까?")) return;
            showLoading(true);
            const mainHeroFile = document.getElementById('conf-main-hero').files[0];
            let mainHeroUrl = originalMainHero;
            if (isMainHeroDeleted) mainHeroUrl = null;
            if (mainHeroFile) {
                const { data } = await window.sb.storage.from('images').upload(`main_${Date.now()}`, mainHeroFile);
                if (data) mainHeroUrl = window.sb.storage.from('images').getPublicUrl(data.path).data.publicUrl;
            }
            const updateData = {
                company_name: document.getElementById('conf-name').value,
                ceo_name: document.getElementById('conf-ceo').value,
                address: document.getElementById('conf-addr').value,
                phone: document.getElementById('conf-phone').value,
                primary_color: document.getElementById('conf-primary').value,
                accent_color: document.getElementById('conf-accent').value,
                main_hero_title: document.getElementById('conf-main-title').value,
                main_hero_desc: document.getElementById('conf-main-desc').value,
                main_hero_title_color: document.getElementById('conf-main-title-color').value,
                main_hero_desc_color: document.getElementById('conf-main-desc-color').value,
                main_hero_image: mainHeroUrl,
                main_hero_bg_color: document.getElementById('conf-main-bg-color').value,
                main_hero_overlay_color: document.getElementById('conf-main-overlay-color').value,
                main_hero_overlay_opacity: parseFloat(document.getElementById('conf-main-overlay-opacity').value),
                updated_at: new Date()
            };
            const { error } = await window.sb.from('site_config').update(updateData).eq('id', 1);
            showLoading(false);
            if (error) alert(error.message); else { alert("저장됨"); if (mainHeroUrl) originalMainHero = mainHeroUrl; location.reload(); }
        };
        window.switchTab = function (tabName, navEl) {
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            if (navEl) navEl.classList.add('active');
            document.querySelectorAll('.admin-section').forEach(sec => sec.classList.remove('active'));
            document.getElementById('tab-' + tabName).classList.add('active');
            if (tabName === 'posts') loadManageList(1);
        };
        window.adminLogin = async function () { const e = document.getElementById('admin-email').value, p = document.getElementById('admin-password').value; const { error } = await window.sb.auth.signInWithPassword({ email: e, password: p }); if (error) alert(error.message); else { showAdminMode(); loadConfigToForm(); loadAdminCategories(); populateCategorySelects(); } };
        window.adminLogout = async function () { await window.sb.auth.signOut(); location.reload(); };
        function showAdminMode() { document.getElementById('login-section').style.display = 'none'; document.getElementById('admin-layout').style.display = 'flex'; loadManageList(1); }
        function showLoading(s) { document.getElementById('loading').style.display = s ? 'flex' : 'none'; }
        function deleteMainHeroImage() { if (!confirm("삭제?")) return; document.getElementById('preview-main-hero').src = "https://via.placeholder.com/300x170?text=No+Image"; document.getElementById('conf-main-hero').value = ""; isMainHeroDeleted = true; }
        window.saveSheetUrl = function () { const input = document.getElementById('sheet-url-input'); let url = input.value.trim(); if (!url) return alert("주소를 입력해주세요."); if (!url.startsWith('http')) url = 'https://' + url; localStorage.setItem('mySheetUrl', url); alert("저장되었습니다."); };
        window.openSavedSheet = function () { const url = localStorage.getItem('mySheetUrl'); if (url && url !== "null") window.open(url, '_blank'); else { alert("저장된 주소가 없습니다."); switchTab('sheets', document.querySelectorAll('.nav-item')[3]); } };
        async function loadManageList(p) { /* 기존 코드 유지 */ currentPage = p; const cat = document.getElementById('filter-category').value; const from = (p - 1) * ITEMS_PER_PAGE; let q = window.sb.from('total_posts').select('*', { count: 'exact' }); if (cat !== 'all') q = q.eq('category', cat); const { data, count } = await q.order('order_num', { ascending: true }).order('created_at', { ascending: false }).range(from, from + ITEMS_PER_PAGE - 1); const list = document.getElementById('manage-list'); list.innerHTML = ""; if (!data || data.length === 0) { list.innerHTML = "<p style='text-align:center; padding:50px; grid-column:1/-1;'>등록된 글이 없습니다.</p>"; return; } data.forEach(item => { const thumb = item.thumbnail_url || 'https://via.placeholder.com/300x200?text=No+Image'; let catName = item.category; const opt = document.querySelector(`#post-category option[value="${item.category}"]`); if (opt) catName = opt.innerText; let badge = ""; const v = item.video_url || ""; if (v === FLAG_ORDER_ONLY) badge = `<span class="badge" style="background:#fff3cd; color:#856404;">📦발주전용</span>`; else if (v.startsWith(FLAG_ORDER_ALL)) badge = `<span class="badge" style="background:#d4edda; color:#155724;">✅통합노출</span>`; else badge = `<span class="badge" style="background:#eef6ff; color:#1a3c6e;">📖소개전용</span>`; list.innerHTML += `<div class="post-manage-card"><img src="${thumb}" class="pm-thumb" alt="thumbnail"><div class="pm-body"><div style="margin-bottom:5px;">${badge} <span class="pm-cat-badge">${catName}</span></div><div class="pm-title" onclick='editPost(${JSON.stringify(item).replace(/'/g, "&#39;")})'>${item.title}</div><div class="pm-info">순서: ${item.order_num}</div></div><div class="pm-actions"><button onclick='editPost(${JSON.stringify(item).replace(/'/g, "&#39;")})' class="pm-btn">수정</button><button onclick='deletePost(${item.id})' class="pm-btn">삭제</button></div></div>`; }); renderPagination(count, currentPage); }
        function renderPagination(t, c) { const p = document.getElementById('pagination-controls'); p.innerHTML = ""; const tp = Math.ceil(t / ITEMS_PER_PAGE); if (tp <= 1) return; for (let i = 1; i <= tp; i++) p.innerHTML += `<button class="page-btn ${i === c ? 'active' : ''}" onclick="loadManageList(${i})">${i}</button>`; }
        window.editPost = function (i) { editingId = i.id; originalDetailUrl = i.image_url; originalThumbUrl = i.thumbnail_url; document.getElementById('post-category').value = i.category; document.getElementById('post-title').value = i.title; quill.root.innerHTML = i.content || ""; document.getElementById('post-link').value = i.link_url || ""; document.getElementById('post-order').value = i.order_num || 0; let val = i.video_url || ""; const chkIntro = document.getElementById('chk-intro'); const chkOrder = document.getElementById('chk-order'); const youtubeInput = document.getElementById('youtube-url'); if (val === FLAG_ORDER_ONLY) { chkIntro.checked = false; chkOrder.checked = true; youtubeInput.value = ""; } else if (val.startsWith(FLAG_ORDER_ALL)) { chkIntro.checked = true; chkOrder.checked = true; youtubeInput.value = val.replace(FLAG_ORDER_ALL, '').replace('|', ''); } else { chkIntro.checked = true; chkOrder.checked = false; youtubeInput.value = val; } toggleEditorState(); document.getElementById('form-title').innerText = "✏️ 수정 모드"; document.getElementById('btn-submit').innerText = "수정 완료"; document.getElementById('btn-cancel-edit').style.display = "inline-block"; window.scrollTo({ top: 0, behavior: 'smooth' }); };
        window.cancelEdit = function () { editingId = null; document.getElementById('post-title').value = ""; quill.root.innerHTML = ""; document.querySelectorAll('input[type="file"]').forEach(i => i.value = ""); document.getElementById('chk-intro').checked = true; document.getElementById('chk-order').checked = false; toggleEditorState(); document.getElementById('form-title').innerText = "📝 게시글 작성/수정"; document.getElementById('btn-submit').innerText = "업로드 저장"; document.getElementById('btn-cancel-edit').style.display = "none"; };
        window.deletePost = async function (id) { if (confirm("삭제?")) { await window.sb.from('total_posts').delete().eq('id', id); loadManageList(currentPage); } };
        async function uploadAndInsertImages(files) { showLoading(true); const r = quill.getSelection(true); let idx = r ? r.index : quill.getLength(); for (const f of files) { if (!f.type.startsWith('image/')) continue; const n = `c_${Date.now()}_${f.name}`; await window.sb.storage.from('images').upload(n, f); const { data } = window.sb.storage.from('images').getPublicUrl(n); quill.insertEmbed(idx++, 'image', data.publicUrl); } showLoading(false); }
    </script>
</body>
</html>