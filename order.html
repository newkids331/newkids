<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>뉴키즈 - 교재 발주 요청</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header></header>

    <section class="sub-hero bg-order">
        <div class="container">
            <h1>교재 발주 요청</h1>
            <p>카테고리를 선택하고 연령과 수량을 입력해 주세요.</p>
        </div>
    </section>

    <section style="background-color: #f8f9fa;">
        <div class="container">
            <form id="orderForm" class="proposal-box">
                <h3 class="form-section-title">👤 주문자 정보</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">원명 (필수)</label>
                        <input type="text" name="wonName" class="form-input" placeholder="예: 해바라기 어린이집" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">담당자 성함 (필수)</label>
                        <input type="text" name="manager" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">연락처 (필수)</label>
                        <input type="tel" name="phone" class="form-input" placeholder="010-0000-0000" maxlength="13" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">이메일</label>
                        <input type="email" name="email" class="form-input" placeholder="sample@email.com">
                    </div>
                </div>

                <div class="form-group" style="margin-top:20px;">
                    <label class="form-label">납품 희망 날짜 (선택)</label>
                    <input type="date" name="deliveryDate" class="form-input" style="max-width: 300px;">
                </div>

                <h3 class="form-section-title" style="margin-top: 40px;">📦 교재 선택 (카테고리 클릭)</h3>

                <div id="loading-msg" style="text-align:center; padding:30px; color:#666;">
                    상품 정보를 불러오는 중입니다...
                </div>

                <div id="product-list-area" class="order-list-box"></div>

                <div class="form-group full-width" style="margin-top: 20px;">
                    <label class="form-label">기타 요청사항</label>
                    <textarea name="remarks" class="form-input" style="height: 80px;" placeholder="추가 전달 사항이 있다면 적어주세요."></textarea>
                </div>

                <div class="btn-center-wrap">
                    <button type="submit" class="btn-action">발주하기</button>
                </div>
            </form>
        </div>
    </section>

    <footer></footer>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script src="manager.js"></script>

    <script>
        let CATEGORY_NAMES = {};

        function escapeHtml(text) {
            if (!text) return "";
            return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }

        document.addEventListener("DOMContentLoaded", function () {
            const checkSb = setInterval(() => {
                if (window.sb) {
                    clearInterval(checkSb);
                    loadDynamicOrderProducts(window.sb);
                }
            }, 100);

            const phoneInput = document.querySelector('input[name="phone"]');
            if (phoneInput) {
                phoneInput.addEventListener('input', function (e) {
                    let number = e.target.value.replace(/[^0-9]/g, "");
                    let tel = "";
                    if (number.startsWith('02')) {
                        if (number.length < 3) { tel = number; } else if (number.length < 6) { tel = number.substr(0, 2) + "-" + number.substr(2); } else { tel = number.substr(0, 2) + "-" + number.substr(2, 4) + "-" + number.substr(6); }
                    } else {
                        if (number.length < 4) { tel = number; } else if (number.length < 7) { tel = number.substr(0, 3) + "-" + number.substr(3); } else { tel = number.substr(0, 3) + "-" + number.substr(3, 4) + "-" + number.substr(7); }
                    }
                    e.target.value = tel;
                });
            }
        });

        async function loadDynamicOrderProducts(sb) {
            try {
                const { data: catData, error: catError } = await sb
                    .from('program_categories')
                    .select('*')
                    .eq('type', 'EDU')
                    .eq('is_visible', true)
                    .order('order_num');

                if (catError || !catData) throw new Error("카테고리 로드 실패");

                const eduCodes = [];
                catData.forEach(c => {
                    CATEGORY_NAMES[c.code] = c.name;
                    eduCodes.push(c.code);
                });

                const { data: posts, error: postError } = await sb.from('total_posts')
                    .select('*')
                    .in('category', eduCodes)
                    .order('order_num', { ascending: true });

                document.getElementById('loading-msg').style.display = 'none';
                const listArea = document.getElementById('product-list-area');

                const groupedData = (posts || []).reduce((acc, item) => {
                    const c = item.category || 'etc';
                    (acc[c] = acc[c] || []).push(item);
                    return acc;
                }, {});

                let html = "";
                eduCodes.forEach(code => {
                    const items = groupedData[code] || [];

                    html += `<div class="category-wrapper">
                                    <div class="order-category-header" onclick="toggleCategory(this)">
                                        <span>${CATEGORY_NAMES[code] || code}</span>
                                        <span class="toggle-icon">▼</span>
                                    </div>
                                    <div class="order-category-content">`;

                    if (items.length > 0) {
                        items.forEach(item => {
                            const safeTitle = escapeHtml(item.title);
                            html += `<div class="order-item-row" data-title="${safeTitle}" onclick="toggleProductItem(this)">
                                            <div class="order-item-info">
                                                <h4>${safeTitle}</h4>
                                                <span class="check-indicator">✔</span>
                                            </div>
                                            <div class="dynamic-qty-container" onclick="event.stopPropagation()">
                                                ${generateDynamicInputArea()}
                                            </div>
                                         </div>`;
                        });
                    } else {
                        html += `<div style="padding:15px; text-align:center; color:#999; font-size:0.9rem;">상품 준비 중입니다.</div>`;
                    }
                    html += `</div></div>`;
                });
                listArea.innerHTML = html;

            } catch (e) {
                console.error(e);
                document.getElementById('loading-msg').innerText = "오류가 발생했습니다.";
            }
        }

        function generateDynamicInputArea() {
            return `<div class="qty-rows-wrapper">
                            <div class="qty-row">
                                <select class="age-select">
                                    <option value="1">1세</option><option value="2">2세</option><option value="3">3세</option>
                                    <option value="4">4세</option><option value="5">5세</option><option value="6">6세</option><option value="7">7세</option>
                                </select>
                                <input type="number" min="0" class="dynamic-qty-input" placeholder="수량" oninput="checkRowData(this)">
                            </div>
                        </div>
                        <button type="button" class="btn-add-row" onclick="addQtyRow(this)">+ 연령 추가하기</button>`;
        }

        // [아코디언 토글] 하나만 열리기
        window.toggleCategory = function (h) {
            if (window.event) window.event.stopPropagation();
            const w = h.closest('.category-wrapper');
            const isActive = w.classList.contains('active');

            document.querySelectorAll('.category-wrapper').forEach(cw => {
                cw.classList.remove('active');
                cw.querySelector('.order-category-content').classList.remove('show');
            });

            if (!isActive) {
                w.classList.add('active');
                w.querySelector('.order-category-content').classList.add('show');
            }
        };

        // [추가됨] 빈 공간 클릭 시 카테고리 닫기
        document.addEventListener('click', function (e) {
            // 클릭된 요소가 카테고리 영역 내부가 아니라면
            if (!e.target.closest('.category-wrapper')) {
                document.querySelectorAll('.category-wrapper').forEach(cw => {
                    cw.classList.remove('active');
                    const content = cw.querySelector('.order-category-content');
                    if (content) content.classList.remove('show');
                });
            }
        });

        window.toggleProductItem = function (r) {
            if (window.event) window.event.stopPropagation();
            const active = r.classList.contains('active');
            const p = r.closest('.order-category-content');
            p.querySelectorAll('.order-item-row.active').forEach(row => row.classList.remove('active'));
            if (!active) r.classList.add('active');
        };

        window.checkRowData = function (el) {
            const r = el.closest('.order-item-row');
            const inputs = r.querySelectorAll('.dynamic-qty-input');
            let has = false; inputs.forEach(i => { if (i.value > 0) has = true; });
            if (has) r.classList.add('has-data'); else r.classList.remove('has-data');

            const w = r.closest('.category-wrapper');
            const h = w.querySelector('.order-category-header');
            const all = w.querySelectorAll('.dynamic-qty-input');
            let t = 0; all.forEach(i => { if (i.value) t += parseInt(i.value) });
            if (t > 0) h.classList.add('has-data'); else h.classList.remove('has-data');
        };

        window.addQtyRow = function (b) {
            const w = b.previousElementSibling;
            const d = document.createElement('div'); d.className = 'qty-row';
            d.innerHTML = `<select class="age-select"><option value="1">1세</option><option value="2">2세</option><option value="3">3세</option><option value="4">4세</option><option value="5">5세</option><option value="6">6세</option><option value="7">7세</option></select><input type="number" min="0" class="dynamic-qty-input" placeholder="수량" oninput="checkRowData(this)"><button type="button" class="btn-remove-row" onclick="removeQtyRow(this)">×</button>`;
            w.appendChild(d);
        };

        window.removeQtyRow = function (b) {
            const row = b.closest('.order-item-row');
            b.parentElement.remove();
            const i = row.querySelectorAll('.dynamic-qty-input');
            if (i.length > 0) checkRowData(i[0]); else {
                row.classList.remove('has-data');
                const w = row.closest('.category-wrapper');
                if (w) {
                    const h = w.querySelector('.order-category-header');
                    const all = w.querySelectorAll('.dynamic-qty-input');
                    let t = 0; all.forEach(v => { if (v.value) t += parseInt(v.value) });
                    if (t > 0) h.classList.add('has-data'); else h.classList.remove('has-data');
                }
            }
        };

        const form = document.getElementById('orderForm');
        if (form) {
            form.addEventListener('submit', function (e) {
                e.preventDefault();
                const btn = form.querySelector('.btn-action');
                const orig = btn.innerText;
                const details = [];
                document.querySelectorAll('.order-item-row').forEach(r => {
                    const t = r.getAttribute('data-title');
                    const rows = r.querySelectorAll('.qty-row');
                    let sub = [];
                    rows.forEach(qr => {
                        const a = qr.querySelector('.age-select').value;
                        const q = parseInt(qr.querySelector('.dynamic-qty-input').value);
                        if (q > 0) sub.push(`${a}세(${q}권)`);
                    });
                    if (sub.length > 0) details.push(`[${t}] : ${sub.join(', ')}`);
                });

                if (details.length === 0) return alert("주문할 교재를 선택해주세요.");

                btn.disabled = true; btn.innerText = "전송 중...";
                const fd = new FormData(form);
                const d = { type: "ORDER", wonName: fd.get("wonName"), manager: fd.get("manager"), phone: fd.get("phone"), email: fd.get("email"), deliveryDate: fd.get("deliveryDate") || "미지정", orderDetails: details.join("\n"), remarks: fd.get("remarks"), timestamp: new Date().toLocaleString() };

                fetch(CONFIG.ORDER_SHEET_URL, { method: "POST", body: JSON.stringify(d) })
                    .then(r => r.json()).then(r => {
                        if (r.result === 'success') { alert("발주 요청이 완료되었습니다!"); location.reload(); }
                        else throw new Error(r.error);
                    }).catch(e => { alert("전송 실패: " + e); btn.disabled = false; btn.innerText = orig; });
            });
        }
    </script>
</body>
</html>