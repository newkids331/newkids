<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>뉴키즈 - 교재 발주 요청</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* [추가] 아코디언이 닫혀도 수량이 있으면 체크 표시 유지 */
        .order-item-row.has-data .check-indicator {
            display: block !important;
            color: var(--primary-color);
        }
    </style>
</head>
<body>
    <header></header>

    <section class="sub-hero bg-order">
        <div class="container">
            <h1>교재 발주 요청</h1>
            <p>카테고리를 선택하고 연령과 수량을 입력해 주세요.</p>
        </div>
    </section>

    <section style="background-color: #f8f9fa;">
        <div class="container">

            <form id="orderForm" class="proposal-box" style="max-width: 900px;">
                <h3 class="form-section-title">👤 주문자 정보</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">원명 (필수)</label>
                        <input type="text" name="wonName" class="form-input" placeholder="예: 해바라기 어린이집" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">담당자 성함 (필수)</label>
                        <input type="text" name="manager" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">연락처 (필수)</label>
                        <input type="tel" name="phone" class="form-input" placeholder="010-0000-0000" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">이메일</label>
                        <input type="email" name="email" class="form-input" placeholder="sample@email.com">
                    </div>
                </div>

                <div class="form-group" style="margin-top:20px;">
                    <label class="form-label">납품 희망 날짜 (선택)</label>
                    <input type="date" name="deliveryDate" class="form-input" style="max-width: 300px;">
                </div>

                <h3 class="form-section-title" style="margin-top: 40px;">📦 교재 선택 (카테고리 클릭)</h3>
                <div id="loading-msg" style="text-align:center; padding:30px; color:#666;">상품 정보를 불러오는 중입니다...</div>

                <div id="product-list-area" class="order-list-box"></div>

                <div class="form-group full-width" style="margin-top: 20px;">
                    <label class="form-label">기타 요청사항</label>
                    <textarea name="remarks" class="form-input" style="height: 80px;" placeholder="추가 전달 사항이 있다면 적어주세요."></textarea>
                </div>

                <div class="btn-center-wrap">
                    <button onclick="submitOrder()" class="btn-action">발주하기</button>
                </div>
            </form>

        </div>
    </section>

    <footer></footer>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script src="manager.js"></script>

    <script>
        const TARGET_CATEGORIES = ['korean', 'art', 'science', 'coding', 'english', 'integrated'];
        const CATEGORY_NAMES = {
            'korean': '📚 한글 & 독서', 'art': '🎨 미술 & 자연', 'science': '🔬 수학 & 과학',
            'coding': '💻 코딩 & 직업', 'english': '🔤 영어 & 지도', 'integrated': '👶 통합보육 & 누리'
        };

        function escapeHtml(text) {
            if (!text) return "";
            return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }

        document.addEventListener("DOMContentLoaded", function () {
            let attempts = 0;
            const checkSb = setInterval(() => {
                attempts++;
                if (window.sb) {
                    clearInterval(checkSb);
                    loadOrderProducts(window.sb);
                } else if (attempts > 50) {
                    clearInterval(checkSb);
                    document.getElementById('loading-msg').innerHTML = "<span style='color:red;'>서버 연결 실패. 새로고침 해주세요.</span>";
                }
            }, 100);
        });

        async function loadOrderProducts(sb) {
            try {
                const { data, error } = await sb.from('total_posts').select('*').in('category', TARGET_CATEGORIES).order('category', { ascending: true }).order('order_num', { ascending: true });
                const listArea = document.getElementById('product-list-area');
                document.getElementById('loading-msg').style.display = 'none';

                if (error || !data || data.length === 0) {
                    listArea.innerHTML = `<div style="padding:40px; text-align:center; color:#888;">주문 가능한 상품이 없습니다.</div>`;
                    return;
                }

                const groupedData = data.reduce((acc, item) => {
                    const cat = item.category || 'etc';
                    (acc[cat] = acc[cat] || []).push(item);
                    return acc;
                }, {});

                let html = "";
                TARGET_CATEGORIES.forEach(cat => {
                    if (groupedData[cat] && groupedData[cat].length > 0) {
                        html += `<div class="category-wrapper">`;
                        html += `<div class="order-category-header" onclick="toggleCategory(this)"><span>${CATEGORY_NAMES[cat] || cat}</span><span class="toggle-icon">▼</span></div>`;

                        html += `<div class="order-category-content">`;
                        groupedData[cat].forEach(item => {
                            const safeTitle = escapeHtml(item.title || "제목 없음");
                            html += `
                                        <div class="order-item-row" data-title="${safeTitle}" onclick="toggleProductItem(this)">
                                            <div class="order-item-info"><h4>${safeTitle}</h4><span class="check-indicator">✔</span></div>
                                            <div class="dynamic-qty-container" onclick="event.stopPropagation()">
                                                ${generateDynamicInputArea()}
                                            </div>
                                        </div>`;
                        });
                        html += `</div>`;
                        html += `</div>`;
                    }
                });
                listArea.innerHTML = html;
            } catch (e) {
                console.error(e);
            }
        }

        // 1. 카테고리 아코디언 (하나만 열기)
        window.toggleCategory = function (header) {
            if (window.event) window.event.stopPropagation();
            const isAlreadyActive = header.classList.contains('active');

            // 모든 카테고리 닫기
            document.querySelectorAll('.order-category-header.active').forEach(h => {
                h.classList.remove('active');
                h.nextElementSibling.classList.remove('show');
            });

            // 클릭한 것만 다시 열기
            if (!isAlreadyActive) {
                header.classList.add('active');
                header.nextElementSibling.classList.add('show');
            }
        };

        // 2. [수정] 상품 아코디언 (하나만 열기)
        window.toggleProductItem = function (row) {
            if (window.event) window.event.stopPropagation(); // 클릭 전파 중단

            const isAlreadyActive = row.classList.contains('active');

            // 현재 카테고리 내의 다른 모든 상품 닫기
            const parent = row.closest('.order-category-content');
            if (parent) {
                parent.querySelectorAll('.order-item-row.active').forEach(r => r.classList.remove('active'));
            }

            // 클릭한 것만 열기
            if (!isAlreadyActive) {
                row.classList.add('active');
            }
        };

        // 3. 배경 클릭 시 모두 닫기 (카테고리 & 상품)
        document.addEventListener('click', function (e) {
            // 카테고리 내용 안쪽을 클릭했다면 카테고리는 닫지 않음
            if (!e.target.closest('.order-category-content')) {
                document.querySelectorAll('.order-category-header.active').forEach(header => {
                    header.classList.remove('active');
                    header.nextElementSibling.classList.remove('show');
                });
            }

            // 상품 내용 안쪽(입력창 등)을 클릭했다면 상품은 닫지 않음
            if (!e.target.closest('.dynamic-qty-container')) {
                // 활성화된 모든 상품 닫기
                document.querySelectorAll('.order-item-row.active').forEach(row => {
                    // 단, 내가 방금 클릭한 row는 제외 (toggleProductItem에서 처리됨)
                    if (row !== e.target.closest('.order-item-row')) {
                        row.classList.remove('active');
                    }
                });
            }
        });

        // 4. [신규] 입력된 값이 있으면 체크 표시 유지 (has-data 클래스 토글)
        window.checkRowData = function (el) {
            const row = el.closest('.order-item-row');
            if (!row) return;

            const inputs = row.querySelectorAll('.dynamic-qty-input');
            let hasValue = false;
            inputs.forEach(input => {
                if (input.value && parseInt(input.value) > 0) hasValue = true;
            });

            if (hasValue) row.classList.add('has-data');
            else row.classList.remove('has-data');
        };

        function generateDynamicInputArea() {
            // oninput 이벤트 추가 (값 입력 시 체크표시 활성화)
            return `
                        <div class="qty-rows-wrapper">
                            <div class="qty-row">
                                <select class="age-select">
                                    <option value="1">1세</option><option value="2">2세</option><option value="3">3세</option>
                                    <option value="4">4세</option><option value="5">5세</option><option value="6">6세</option><option value="7">7세</option>
                                </select>
                                <input type="number" min="0" class="dynamic-qty-input" placeholder="수량 입력" oninput="checkRowData(this)">
                            </div>
                        </div>
                        <button type="button" class="btn-add-row" onclick="addQtyRow(this)">+ 연령 추가하기</button>
                    `;
        }

        window.addQtyRow = function (btn) {
            const wrapper = btn.previousElementSibling;
            const newRow = document.createElement('div');
            newRow.className = 'qty-row';
            newRow.innerHTML = `
                        <select class="age-select">
                            <option value="1">1세</option><option value="2">2세</option><option value="3">3세</option>
                            <option value="4">4세</option><option value="5">5세</option><option value="6">6세</option><option value="7">7세</option>
                        </select>
                        <input type="number" min="0" class="dynamic-qty-input" placeholder="수량 입력" oninput="checkRowData(this)">
                        <button type="button" class="btn-remove-row" onclick="removeQtyRow(this)">×</button>
                    `;
            wrapper.appendChild(newRow);
        };

        window.removeQtyRow = function (btn) {
            const row = btn.closest('.order-item-row');
            btn.parentElement.remove();
            // 삭제 후 남은 데이터가 있는지 재확인
            if (row) {
                const inputs = row.querySelectorAll('.dynamic-qty-input');
                if (inputs.length > 0) checkRowData(inputs[0]);
                else row.classList.remove('has-data');
            }
        };

        const form = document.getElementById('orderForm');
        form.addEventListener('submit', function (e) {
            e.preventDefault();
            const btn = form.querySelector('.btn-submit');
            const originalText = btn.innerText;

            const orderDetails = [];
            document.querySelectorAll('.order-item-row').forEach(row => {
                const title = row.getAttribute('data-title');
                const rows = row.querySelectorAll('.qty-row');
                let hasQty = false;
                let ageStr = [];

                rows.forEach(qtyRow => {
                    const age = qtyRow.querySelector('.age-select').value;
                    const qty = parseInt(qtyRow.querySelector('.dynamic-qty-input').value);
                    if (qty > 0) { hasQty = true; ageStr.push(`${age}세(${qty}권)`); }
                });

                if (hasQty) orderDetails.push(`[${title}] : ${ageStr.join(', ')}`);
            });

            if (orderDetails.length === 0) {
                alert("수량을 입력한 교재가 없습니다.\n카테고리를 클릭하여 교재 선택 및 수량을 입력해 주세요.");
                return;
            }

            btn.disabled = true; btn.innerText = "전송 중...";

            const formData = new FormData(form);
            const data = {
                type: "ORDER",
                wonName: formData.get("wonName"),
                manager: formData.get("manager"),
                phone: formData.get("phone"),
                email: formData.get("email"),
                deliveryDate: formData.get("deliveryDate") || "미지정",
                orderDetails: orderDetails.join("\n"),
                remarks: formData.get("remarks"),
                timestamp: new Date().toLocaleString()
            };

            if (typeof CONFIG === 'undefined' || !CONFIG.ORDER_SHEET_URL) {
                alert("설정 오류: ORDER_SHEET_URL 없음");
                btn.disabled = false; btn.innerText = originalText;
                return;
            }

            fetch(CONFIG.ORDER_SHEET_URL, { method: "POST", body: JSON.stringify(data) })
                .then(res => res.json())
                .then(res => {
                    if (res.result === 'success') { alert("발주 요청이 성공적으로 전송되었습니다."); window.location.reload(); }
                    else { throw new Error(res.error); }
                })
                .catch(err => {
                    console.error(err);
                    alert("전송 실패. 관리자에게 문의하세요.");
                    btn.disabled = false;
                    btn.innerText = originalText;
                });
        });
    </script>
</body>
</html>