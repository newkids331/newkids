<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>뉴키즈 - 상세 내용</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
</head>
<body>
    <header></header>
    <div id="loading" class="loading-overlay">내용을 불러오는 중입니다...</div>

    <section class="sub-hero bg-season" id="view-hero">
        <div class="container">
            <h1 id="page-title">상세 보기</h1>
            <p>뉴키즈의 다양한 활동을 확인해 보세요.</p>
        </div>
    </section>

    <section>
        <div class="container-wide">
            <div class="view-box">
                <div class="view-header">
                    <h2 class="view-title" id="post-title">로딩 중...</h2>
                    <p class="view-date" id="post-date">0000-00-00</p>
                </div>

                <div class="view-media" id="view-media" style="display:none;"></div>

                <div class="view-content ql-editor" id="post-content"></div>

                <div id="link-container" style="text-align: center; margin: 40px 0 20px;"></div>

                <a href="javascript:history.back()" class="btn-list">목록으로 돌아가기</a>
            </div>
        </div>
    </section>

    <footer></footer>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script src="manager.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const params = new URLSearchParams(window.location.search);
            const postId = params.get('id');
            if (postId) loadPostDetail(postId);
        });

        function isVideo(url) {
            return /\.(mp4|webm|ogg|mov|avi|mkv)(\?|$)/i.test(url);
        }

        async function loadPostDetail(id) {
            document.getElementById('loading').style.display = 'flex';
            try {
                const { data, error } = await window.sb.from('total_posts').select('*').eq('id', id).single();
                if (error || !data) throw new Error("데이터 없음");

                document.getElementById('post-title').innerText = data.title;
                document.getElementById('post-date').innerText = window.formatDate(data.created_at);
                document.getElementById('post-content').innerHTML = data.content;

                // [미디어 처리]
                const mediaBox = document.getElementById('view-media');
                mediaBox.innerHTML = '';

                if (data.video_url && data.video_url !== 'null' && data.video_url.trim() !== '') {
                    const yid = window.getYoutubeId(data.video_url);
                    mediaBox.innerHTML = yid ? `<iframe src="https://www.youtube.com/embed/${yid}" frameborder="0" allowfullscreen></iframe>`
                        : `<video controls style="width:100%; border-radius:10px;"><source src="${data.video_url}"></video>`;
                    mediaBox.style.display = 'block';
                }
                else if (data.image_url && data.image_url !== 'null' && data.image_url.trim() !== '') {
                    if (isVideo(data.image_url)) {
                        mediaBox.innerHTML = `<video controls style="width:100%; border-radius:10px;"><source src="${data.image_url}"></video>`;
                    } else {
                        mediaBox.innerHTML = `<img src="${data.image_url}" onerror="this.parentElement.style.display='none'">`;
                    }
                    mediaBox.style.display = 'block';
                } else {
                    mediaBox.style.display = 'none';
                }

                // [링크 버튼 처리]
                const linkBox = document.getElementById('link-container');
                linkBox.innerHTML = "";

                if (data.link_url && data.link_url.trim() !== "" && data.link_url !== "null") {
                    let finalLink = data.link_url;
                    if (!finalLink.startsWith('http')) {
                        finalLink = 'https://' + finalLink;
                    }
                    linkBox.innerHTML = `
                                <a href="${finalLink}" target="_blank" class="link-btn-style">
                                    🔗 관련 사이트 바로가기
                                </a>
                            `;
                }

                updateHeroBackground(data.category);

            } catch (err) {
                console.error(err);
                alert("불러오기 실패");
                history.back();
            }
            finally { document.getElementById('loading').style.display = 'none'; }
        }

        function updateHeroBackground(category) {
            const hero = document.getElementById('view-hero');
            const catMap = {
                'season': 'bg-season', 'culture': 'bg-culture', 'performance': 'bg-performance',
                'korean': 'bg-child', 'reading': 'bg-child', 'english': 'bg-child',
                'math': 'bg-child', 'science': 'bg-child', 'art': 'bg-child',
                'coding': 'bg-child', 'environment': 'bg-child', 'nuri': 'bg-child',
                'infant': 'bg-child', 'special': 'bg-child'
            };
            hero.className = 'sub-hero ' + (catMap[category] || 'bg-gray');
        }
    </script>
</body>
</html>