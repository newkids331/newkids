<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‰´í‚¤ì¦ˆ - ì œì•ˆ/ê²¬ì  ìš”ì²­</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header></header>

    <section class="sub-hero bg-proposal">
        <div class="container">
            <h1>ì œì•ˆì„œ ë° ê²¬ì  ìš”ì²­</h1>
            <p>ê´€ì‹¬ ìˆëŠ” ì¹´í…Œê³ ë¦¬ë¥¼ ì²´í¬í•˜ê³  ì„¸ë¶€ í”„ë¡œê·¸ë¨ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.</p>
        </div>
    </section>

    <section style="background-color: #f8f9fa;">
        <div class="container">

            <form id="proposalForm" class="proposal-box">
                <h3 class="form-section-title">ğŸ‘¤ ì‹ ì²­ì ì •ë³´</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">ì›ëª… (í•„ìˆ˜)</label>
                        <input type="text" name="wonName" class="form-input" placeholder="ì˜ˆ: í•´ë°”ë¼ê¸° ì–´ë¦°ì´ì§‘" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ë‹´ë‹¹ì ì„±í•¨ (í•„ìˆ˜)</label>
                        <input type="text" name="manager" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ì—°ë½ì²˜ (í•„ìˆ˜)</label>
                        <input type="tel" name="phone" class="form-input" placeholder="010-0000-0000" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ë°©ë¬¸ í¬ë§ ë‚ ì§œ (ì„ íƒ)</label>
                        <input type="date" name="visitDate" class="form-input">
                    </div>
                </div>

                <h3 class="form-section-title" style="margin-top: 30px;">ğŸ“š ê´€ì‹¬ í”„ë¡œê·¸ë¨ ì„ íƒ</h3>
                <p style="font-size:0.9rem; color:#666; margin-bottom:15px;">
                    <strong>[ì‚¬ìš©ë²•]</strong> ì›í•˜ì‹œëŠ” <u>ì¹´í…Œê³ ë¦¬(ì¤‘ë¶„ë¥˜)ë¥¼ ë¨¼ì € ì²´í¬</u>í•˜ì‹œë©´ ìƒì„¸ í”„ë¡œê·¸ë¨ì„ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                </p>

                <div id="loading-msg" style="text-align:center; padding:20px; color:#666;">ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>

                <div id="proposal-list-area" class="proposal-list-box"></div>

                <div class="form-group full-width" style="margin-top: 30px;">
                    <label class="form-label">ë¬¸ì˜ì‚¬í•­ ë° ìš”ì²­ ë‚´ìš©</label>
                    <textarea name="inquiry" class="form-input" placeholder="ê¶ê¸ˆí•˜ì‹  ì ì´ë‚˜ íŠ¹ë³„íˆ ìš”ì²­í•˜ì‹¤ ë‚´ìš©ì„ ììœ ë¡­ê²Œ ì ì–´ì£¼ì„¸ìš”."></textarea>
                </div>

                <button type="submit" class="btn-submit">ê²¬ì  ë° ìƒë‹´ ìš”ì²­í•˜ê¸°</button>
            </form>

        </div>
    </section>

    <footer></footer>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script src="manager.js"></script>

    <script>
        const EDU_CATS = ['korean', 'art', 'science', 'coding', 'english', 'integrated'];
        const EVENT_CATS = ['season', 'culture', 'performance'];

        const CAT_NAMES = {
            'korean': 'ğŸ“š í•œê¸€ & ë…ì„œ',
            'art': 'ğŸ¨ ë¯¸ìˆ  & ìì—°',
            'science': 'ğŸ”¬ ìˆ˜í•™ & ê³¼í•™',
            'coding': 'ğŸ’» ì½”ë”© & ì§ì—…',
            'english': 'ğŸ”¤ ì˜ì–´ & ì§€ë„',
            'integrated': 'ğŸ‘¶ í†µí•©ë³´ìœ¡ & ëˆ„ë¦¬',
            'season': 'ğŸ‰ ì‹œì¦Œ í…Œë§ˆ í–‰ì‚¬',
            'culture': 'ğŸŒ ì›ì–´ë¯¼ í–‰ì‚¬',
            'performance': 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ ë¶€ëª¨ ì°¸ì—¬ í–‰ì‚¬'
        };

        function escapeHtml(text) {
            if (!text) return "";
            return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }

        document.addEventListener("DOMContentLoaded", function () {
            let attempts = 0;
            const checkSb = setInterval(() => {
                attempts++;
                if (window.sb) {
                    clearInterval(checkSb);
                    loadProposalItems(window.sb);
                } else if (attempts > 50) {
                    clearInterval(checkSb);
                    document.getElementById('loading-msg').innerText = "ë°ì´í„° ë¡œë”© ì‹¤íŒ¨ (ì„œë²„ ì—°ê²° ë¶ˆê°€)";
                }
            }, 100);
        });

        async function loadProposalItems(sb) {
            try {
                const allCats = [...EDU_CATS, ...EVENT_CATS];
                const { data, error } = await sb
                    .from('total_posts')
                    .select('id, title, category')
                    .in('category', allCats)
                    .order('category', { ascending: true })
                    .order('created_at', { ascending: false });

                const listArea = document.getElementById('proposal-list-area');
                document.getElementById('loading-msg').style.display = 'none';

                if (error) { console.error(error); return; }

                const grouped = data.reduce((acc, item) => {
                    const c = item.category;
                    (acc[c] = acc[c] || []).push(item);
                    return acc;
                }, {});

                let html = "";

                // --- ê·¸ë£¹ ìƒì„± í—¬í¼ í•¨ìˆ˜ ---
                const createGroupHTML = (title, categories) => {
                    let groupHtml = `<div class="category-wrapper">`;
                    groupHtml += `   <div class="proposal-category-header" onclick="toggleProposalCategory(this)">
                                                <span>${title}</span> <span class="toggle-icon">â–¼</span>
                                            </div>`;
                    groupHtml += `   <div class="proposal-category-content">`;

                    let hasItem = false;
                    categories.forEach(cat => {
                        if (grouped[cat] && grouped[cat].length > 0) {
                            hasItem = true;
                            // [ì¤‘ìš”] ì¤‘ë¶„ë¥˜ í—¤ë” (ì²´í¬ë°•ìŠ¤ í¬í•¨)
                            groupHtml += `
                                        <div class="sub-cat-header" onclick="toggleSubCategory(this, event)">
                                            <input type="checkbox" class="parent-check" data-cat="${cat}">
                                            <span>${CAT_NAMES[cat] || cat}</span>
                                        </div>
                                    `;
                            // [ì¤‘ìš”] í•˜ìœ„ ì•„ì´í…œ ê·¸ë¦¬ë“œ (ê¸°ë³¸ ë¹„í™œì„±)
                            groupHtml += `<div id="grid-${cat}" class="proposal-check-grid">`;
                            grouped[cat].forEach(item => {
                                const safeTitle = escapeHtml(item.title);
                                const val = `[${CAT_NAMES[cat]}] ${safeTitle}`;
                                groupHtml += `
                                            <label class="proposal-item">
                                                <input type="checkbox" name="interest" value="${val}" disabled>
                                                <span>${safeTitle}</span>
                                            </label>`;
                            });
                            groupHtml += `</div>`;
                        }
                    });
                    if (!hasItem) groupHtml += `<p style="color:#999; padding:10px;">ë“±ë¡ëœ í”„ë¡œê·¸ë¨ì´ ì—†ìŠµë‹ˆë‹¤.</p>`;
                    groupHtml += `   </div></div>`;
                    return groupHtml;
                };

                // 1. êµìœ¡ í”„ë¡œê·¸ë¨
                html += createGroupHTML("ğŸ“ êµìœ¡ í”„ë¡œê·¸ë¨", EDU_CATS);
                // 2. í–‰ì‚¬ í”„ë¡œê·¸ë¨
                html += createGroupHTML("ğŸ‰ í–‰ì‚¬ í”„ë¡œê·¸ë¨", EVENT_CATS);

                listArea.innerHTML = html;

            } catch (e) { console.error(e); }
        }

        // [ê¸°ëŠ¥ 1] ëŒ€ë¶„ë¥˜(ì•„ì½”ë””ì–¸) í† ê¸€
        window.toggleProposalCategory = function (header) {
            header.classList.toggle('active');
            header.nextElementSibling.classList.toggle('show');
        };

        // [ê¸°ëŠ¥ 2] ì¤‘ë¶„ë¥˜ ì²´í¬ ì‹œ -> í•˜ìœ„ í•­ëª© í™œì„±í™”/ë¹„í™œì„±í™”
        window.toggleSubCategory = function (headerDiv, e) {
            // ì´ë²¤íŠ¸ ë²„ë¸”ë§ ë°©ì§€ (ì²´í¬ë°•ìŠ¤ ì§ì ‘ í´ë¦­ ì‹œ)
            // eê°€ ì „ë‹¬ë˜ì§€ ì•Šì•˜ì„ ê²½ìš°(window.event ì‚¬ìš©)ë¥¼ ëŒ€ë¹„
            const target = e ? e.target : (window.event ? window.event.target : null);

            if (target && target.tagName === 'INPUT') {
                handleSubCategoryCheck(target);
                return;
            }

            // í—¤ë” ì˜ì—­(div) í´ë¦­ ì‹œ ë‚´ë¶€ ì²´í¬ë°•ìŠ¤ ìƒíƒœ ë³€ê²½
            const checkbox = headerDiv.querySelector('input[type="checkbox"]');
            checkbox.checked = !checkbox.checked;
            handleSubCategoryCheck(checkbox);
        };

        function handleSubCategoryCheck(checkbox) {
            const cat = checkbox.getAttribute('data-cat');
            const grid = document.getElementById(`grid-${cat}`);
            const header = checkbox.closest('.sub-cat-header');
            const childInputs = grid.querySelectorAll('input[type="checkbox"]');

            if (checkbox.checked) {
                // í™œì„±í™”
                grid.classList.add('active');
                header.classList.add('active');
                childInputs.forEach(input => input.disabled = false);
            } else {
                // ë¹„í™œì„±í™”
                grid.classList.remove('active');
                header.classList.remove('active');
                childInputs.forEach(input => {
                    input.disabled = true;
                    input.checked = false;
                });
            }
        }

        // ì „ì†¡ ë¡œì§
        const form = document.getElementById('proposalForm');
        form.addEventListener('submit', function (e) {
            e.preventDefault();
            const btn = form.querySelector('.btn-submit');
            const originalText = btn.innerText;

            // ì„ íƒëœ í•­ëª© + ì¹´í…Œê³ ë¦¬ ìì²´ë„ ê´€ì‹¬ìˆìœ¼ë©´ í¬í•¨
            const interests = [];

            // 1. í•˜ìœ„ í•­ëª© ì²´í¬ëœ ê²ƒ ìˆ˜ì§‘
            form.querySelectorAll('input[name="interest"]:checked').forEach(cb => {
                interests.push(cb.value);
            });

            // 2. í•˜ìœ„ í•­ëª©ì€ ì—†ì§€ë§Œ ì¹´í…Œê³ ë¦¬(ì¤‘ë¶„ë¥˜)ë§Œ ì²´í¬í•œ ê²½ìš°ë„ ìˆ˜ì§‘
            document.querySelectorAll('.parent-check:checked').forEach(parent => {
                const catCode = parent.getAttribute('data-cat');
                const catName = CAT_NAMES[catCode];
                const hasChildChecked = interests.some(val => val.includes(`[${catName}]`));
                if (!hasChildChecked) {
                    interests.push(`[ê´€ì‹¬ë¶„ì•¼] ${catName} (ì„¸ë¶€í•­ëª© ë¯¸ì„ íƒ)`);
                }
            });

            if (interests.length === 0) {
                if (!confirm("ì„ íƒí•˜ì‹  í”„ë¡œê·¸ë¨ì´ ì—†ìŠµë‹ˆë‹¤. ìƒë‹´ë§Œ ìš”ì²­í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            }

            btn.disabled = true;
            btn.innerText = "ì „ì†¡ ì¤‘...";

            const formData = new FormData(form);
            const data = {
                type: "PROPOSAL",
                wonName: formData.get("wonName"),
                manager: formData.get("manager"),
                phone: formData.get("phone"),
                orderDetails: interests.length > 0 ? interests.join("\n") : "ë¬¸ì˜ ì‚¬í•­ ì°¸ì¡°",
                deliveryDate: formData.get("visitDate") || "ë¯¸ì§€ì •",
                remarks: formData.get("inquiry"),
                email: "",
                timestamp: new Date().toLocaleString()
            };

            if (typeof CONFIG === 'undefined' || !CONFIG.PROPOSAL_SHEET_URL) {
                alert("ì„¤ì • ì˜¤ë¥˜: PROPOSAL_SHEET_URL ì—†ìŒ");
                btn.disabled = false; btn.innerText = originalText;
                return;
            }

            fetch(CONFIG.PROPOSAL_SHEET_URL, {
                method: "POST",
                body: JSON.stringify(data)
            })
                .then(res => res.json())
                .then(res => {
                    if (res.result === 'success') {
                        alert("ì„±ê³µì ìœ¼ë¡œ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.");
                        window.location.reload();
                    } else { throw new Error(res.error); }
                })
                .catch(err => {
                    console.error(err);
                    alert("ì „ì†¡ ì˜¤ë¥˜ ë°œìƒ");
                    btn.disabled = false;
                    btn.innerText = originalText;
                });
        });
    </script>
</body>
</html>