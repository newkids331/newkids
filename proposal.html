<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‰´í‚¤ì¦ˆ - ê²¬ì  ìš”ì²­</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header></header>

    <section class="sub-hero bg-proposal">
        <div class="container">
            <h1>ê²¬ì  ìš”ì²­</h1>
            <p>ê¶ê¸ˆí•˜ì‹  êµì¬ì™€ í”„ë¡œê·¸ë¨ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.</p>
        </div>
    </section>

    <section style="background-color: #f8f9fa;">
        <div class="container">
            <form id="proposalForm" class="proposal-box">
                <h3 class="form-section-title">ğŸ‘¤ ì‹ ì²­ì ì •ë³´</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">ì›ëª… (í•„ìˆ˜)</label>
                        <input type="text" name="wonName" class="form-input" placeholder="ì˜ˆ: í•´ë°”ë¼ê¸° ì–´ë¦°ì´ì§‘" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ë‹´ë‹¹ì ì„±í•¨ (í•„ìˆ˜)</label>
                        <input type="text" name="manager" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ì—°ë½ì²˜ (í•„ìˆ˜)</label>
                        <input type="tel" name="phone" class="form-input" placeholder="010-0000-0000" maxlength="13" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ì´ë©”ì¼</label>
                        <input type="email" name="email" class="form-input" placeholder="sample@email.com">
                    </div>
                </div>

                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">ì§€ì—­ (ì‹œ/êµ¬) (í•„ìˆ˜)</label>
                        <input type="text" name="region" class="form-input" placeholder="ì˜ˆ: ì„œìš¸ ê°•ë‚¨êµ¬" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">í¬ë§ ë°©ë¬¸ìƒë‹´ ë‚ ì§œ</label>
                        <input type="date" name="visitDate" class="form-input">
                    </div>
                </div>

                <h3 class="form-section-title" style="margin-top: 40px;">ğŸ“ ê´€ì‹¬ êµìœ¡ í”„ë¡œê·¸ë¨ ì„ íƒ</h3>
                <div id="loading-msg" style="text-align:center; padding:30px; color:#666;">ëª©ë¡ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>

                <div id="proposal-grid-area" class="proposal-grid-container"></div>

                <h3 class="form-section-title" style="margin-top: 40px;">ğŸ‰ ê´€ì‹¬ í–‰ì‚¬ í”„ë¡œê·¸ë¨ ì„ íƒ</h3>

                <div id="event-grid-area" class="proposal-grid-container"></div>

                <div class="form-group full-width" style="margin-top: 30px;">
                    <label class="form-label">ë¬¸ì˜ ë‚´ìš© / ë¹„ê³ </label>
                    <textarea name="inquiry" class="form-input" style="height: 100px;" placeholder="ê¶ê¸ˆí•˜ì‹  ì ì´ë‚˜ ìš”ì²­ì‚¬í•­ì„ ì ì–´ì£¼ì„¸ìš”."></textarea>
                </div>

                <div class="btn-center-wrap">
                    <button type="submit" class="btn-action">ê²¬ì  ìš”ì²­í•˜ê¸°</button>
                </div>
            </form>
        </div>
    </section>

    <footer></footer>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script src="manager.js"></script>

    <script>
        let CATEGORY_NAMES = {};

        function escapeHtml(text) {
            if (!text) return "";
            return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }

        document.addEventListener("DOMContentLoaded", function () {
            // manager.js ë¡œë“œ ëŒ€ê¸°
            const checkSb = setInterval(() => {
                if (window.sb) {
                    clearInterval(checkSb);
                    loadDynamicProposalData(window.sb);
                }
            }, 100);

            // ì „í™”ë²ˆí˜¸ ìë™ì™„ì„±
            const phoneInput = document.querySelector('input[name="phone"]');
            if (phoneInput) {
                phoneInput.addEventListener('input', function (e) {
                    let number = e.target.value.replace(/[^0-9]/g, "");
                    let tel = "";
                    if (number.startsWith('02')) {
                        if (number.length < 3) { tel = number; } else if (number.length < 6) { tel = number.substr(0, 2) + "-" + number.substr(2); } else { tel = number.substr(0, 2) + "-" + number.substr(2, 4) + "-" + number.substr(6); }
                    } else {
                        if (number.length < 4) { tel = number; } else if (number.length < 7) { tel = number.substr(0, 3) + "-" + number.substr(3); } else { tel = number.substr(0, 3) + "-" + number.substr(3, 4) + "-" + number.substr(7); }
                    }
                    e.target.value = tel;
                });
            }
        });

        // [ë°ì´í„° ë¡œë“œ]
        async function loadDynamicProposalData(sb) {
            try {
                const { data: catData, error: catError } = await sb
                    .from('program_categories')
                    .select('*')
                    .eq('is_visible', true)
                    .order('order_num');

                if (catError || !catData) throw new Error("ì¹´í…Œê³ ë¦¬ ë¡œë“œ ì‹¤íŒ¨");

                const eduCats = [];
                const eventCats = [];

                catData.forEach(c => {
                    CATEGORY_NAMES[c.code] = c.name;
                    if (c.type === 'EDU') eduCats.push(c.code); else eventCats.push(c.code);
                });

                const { data: posts, error: postError } = await sb.from('total_posts')
                    .select('title, category, order_num')
                    .order('order_num', { ascending: true });

                document.getElementById('loading-msg').style.display = 'none';

                const groupedData = (posts || []).reduce((acc, item) => {
                    const c = item.category || 'etc';
                    (acc[c] = acc[c] || []).push(item);
                    return acc;
                }, {});

                const createSectionHtml = (categoryCodes) => {
                    let html = "";
                    categoryCodes.forEach(code => {
                        const items = groupedData[code] || [];
                        // ë¹ˆ ì¹´í…Œê³ ë¦¬ë„ í‘œì‹œ (ì‚¬ìš©ì í™•ì¸ìš©)
                        html += `
                            <div class="sub-cat-wrapper">
                                <div class="sub-cat-header" onclick="toggleProposalCategory(this)">
                                    <div class="sub-cat-title">
                                        <span>${CATEGORY_NAMES[code] || code}</span>
                                    </div>
                                    <span class="sub-toggle-icon">â–¼</span>
                                </div>
                                <div class="proposal-check-grid">`;

                        if (items.length > 0) {
                            items.forEach(post => {
                                const safeTitle = escapeHtml(post.title);
                                html += `
                                        <label class="proposal-item">
                                            <input type="checkbox" name="items" value="[${CATEGORY_NAMES[code]}] ${safeTitle}">
                                            <span>${safeTitle}</span>
                                        </label>`;
                            });
                        } else {
                            html += `<div style="padding:10px; color:#999; font-size:0.9rem;">ë“±ë¡ëœ í”„ë¡œê·¸ë¨ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
                        }

                        html += `</div></div>`;
                    });
                    return html;
                };

                document.getElementById('proposal-grid-area').innerHTML = createSectionHtml(eduCats);
                document.getElementById('event-grid-area').innerHTML = createSectionHtml(eventCats);

            } catch (e) {
                console.error(e);
                document.getElementById('loading-msg').innerText = "ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
            }
        }

        // [í•µì‹¬ ìˆ˜ì •] order.htmlê³¼ ë™ì¼í•œ ì•„ì½”ë””ì–¸ ë¡œì§ ì ìš©
        window.toggleProposalCategory = function (header) {
            if (window.event) window.event.stopPropagation();

            // 1. í˜„ì¬ í´ë¦­í•œ ìš”ì†Œì˜ ë˜í¼ì™€ ì—´ë¦¼ ìƒíƒœ í™•ì¸
            const wrapper = header.closest('.sub-cat-wrapper');
            const grid = wrapper.querySelector('.proposal-check-grid');
            const isAlreadyActive = wrapper.classList.contains('active');

            // 2. ë‹¤ë¥¸ ëª¨ë“  ì¹´í…Œê³ ë¦¬ ë‹«ê¸° (ì´ˆê¸°í™”)
            document.querySelectorAll('.sub-cat-wrapper').forEach(w => {
                w.classList.remove('active'); // Wrapperì—ì„œ active ì œê±°
                const g = w.querySelector('.proposal-check-grid');
                if (g) g.classList.remove('show'); // ë‚´ìš© ìˆ¨ê¹€
            });

            // 3. í´ë¦­í•œ ê²ƒì´ ë‹«í˜€ìˆë˜ ìƒíƒœë¼ë©´ -> ì—´ê¸°
            if (!isAlreadyActive) {
                wrapper.classList.add('active'); // Wrapperì— active ì¶”ê°€
                if (grid) grid.classList.add('show'); // ë‚´ìš© ë³´ì´ê¸°
            }
        };

        // ì²´í¬ë°•ìŠ¤ ì„ íƒ ì‹œ í—¤ë” ìƒ‰ìƒ ë³€ê²½ ìœ ì§€
        document.addEventListener('change', function (e) {
            if (e.target.type === 'checkbox' && e.target.closest('.sub-cat-wrapper')) {
                const wrapper = e.target.closest('.sub-cat-wrapper');
                const header = wrapper.querySelector('.sub-cat-header');
                const checked = wrapper.querySelectorAll('input:checked').length > 0;
                if (checked) header.classList.add('has-checked');
                else header.classList.remove('has-checked');
            }
        });

        const form = document.getElementById('proposalForm');
        if (form) {
            form.addEventListener('submit', function (e) {
                e.preventDefault();
                const btn = form.querySelector('.btn-action');
                const originalText = btn.innerText;

                const checkedItems = [];
                form.querySelectorAll('input[name="items"]:checked').forEach(cb => checkedItems.push(cb.value));

                if (checkedItems.length === 0) { alert("ìµœì†Œ 1ê°œ ì´ìƒì˜ í”„ë¡œê·¸ë¨ì„ ì„ íƒí•´ ì£¼ì„¸ìš”."); return; }

                btn.disabled = true; btn.innerText = "ì „ì†¡ ì¤‘...";
                const formData = new FormData(form);
                const data = {
                    type: "PROPOSAL",
                    wonName: formData.get("wonName"),
                    manager: formData.get("manager"),
                    phone: formData.get("phone"),
                    email: formData.get("email"),
                    region: formData.get("region"),
                    visitDate: formData.get("visitDate"),
                    items: checkedItems.join("\n"),
                    inquiry: formData.get("inquiry"),
                    timestamp: new Date().toLocaleString()
                };

                fetch(CONFIG.PROPOSAL_SHEET_URL || CONFIG.ORDER_SHEET_URL, { method: "POST", body: JSON.stringify(data) })
                    .then(res => res.json())
                    .then(res => {
                        if (res.result === 'success') { alert("ê²¬ì  ìš”ì²­ì´ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤."); location.reload(); }
                        else throw new Error(res.error);
                    })
                    .catch(err => { alert("ì „ì†¡ ì‹¤íŒ¨: " + err); btn.disabled = false; btn.innerText = originalText; });
            });
        }
    </script>
</body>
</html>